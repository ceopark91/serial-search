<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì‹œë¦¬ì–¼ ë„˜ë²„ ê²€ìƒ‰ê¸° | Serial Number Search</title>
<style>
:root{
  --bg:#0b1020; --card:#111a33; --line:#23305a;
  --text:#eaf0ff; --muted:#9aa7c2; --accent:#38bdf8; --danger:#fb7185;
}
*{box-sizing:border-box}
body{margin:0; background:linear-gradient(180deg,#0b1020,#05070d); font-family:Pretendard,"Noto Sans KR",system-ui; color:var(--text)}
.wrapper{max-width:1200px; margin:auto; padding:32px 16px 80px}

/* í—¤ë” */
header{margin-bottom:32px; border-bottom:1px solid var(--line); padding-bottom:24px}
header h1{margin:0; font-size:28px; display:flex; align-items:center; gap:12px}
header .logo{width:40px; height:40px; background:var(--accent); border-radius:8px}
header p{margin:8px 0 0; color:var(--muted); font-size:14px}

/* ê²€ìƒ‰ ë°•ìŠ¤ */
.search-box{
  background:var(--card); border:1px solid var(--line); border-radius:16px;
  padding:24px; margin-bottom:32px; display:flex; gap:12px; flex-wrap:wrap;
  align-items:center;
}
.search-box input{
  flex:1; min-width:300px; padding:12px 16px; border-radius:10px;
  border:1px solid var(--line); background:#070a14; color:var(--text); font-size:15px;
}
.search-box input:focus{outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(56,189,248,0.4)}
.search-box button{
  padding:12px 20px; border-radius:10px; border:none;
  font-weight:700; cursor:pointer; transition:all 150ms; font-size:14px;
}
.search-box .btn-search{
  background:var(--accent); color:#000; min-width:100px;
}
.search-box .btn-search:hover{background:#60d5ff; transform:translateY(-2px)}
.search-box .btn-reset{
  background:var(--line); color:var(--text); min-width:80px;
}
.search-box .btn-reset:hover{background:#2d3f5d}

/* ê²°ê³¼ ì˜ì—­ */
.result-area{margin-top:24px}
.result-grid{
  display:grid; grid-template-columns:repeat(2, 1fr); gap:20px;
}

/* ê²°ê³¼ ì¹´ë“œ (2ì—´) */
.card{
  background:var(--card); border:1px solid var(--line); border-radius:14px;
  padding:20px; display:flex; flex-direction:column; gap:16px;
}
.card-header{
  display:flex; align-items:center; gap:12px; padding-bottom:16px;
  border-bottom:1px solid var(--line);
}
.card-title{margin:0; font-size:16px; font-weight:600; color:var(--accent)}
.tag{
  font-size:11px; padding:4px 10px; border-radius:6px;
  background:rgba(56,189,248,0.15); color:var(--accent); border:1px solid var(--accent);
}

/* ì •ë³´ ê·¸ë£¹ (ì¹´ë“œ ë‚´ë¶€ 2ì—´) */
.info-grid{
  display:grid; grid-template-columns:1fr 1fr; gap:12px;
}
.info-item{
  background:rgba(7,10,20,0.5); border:1px solid var(--line); border-radius:10px;
  padding:12px; display:flex; flex-direction:column; gap:6px;
}
.info-label{
  font-size:12px; color:var(--muted); font-weight:500; text-transform:uppercase;
  letter-spacing:0.5px;
}
.info-value{
  font-size:14px; color:var(--text); font-weight:500; word-break:break-word;
  white-space:normal; line-height:1.4;
}

/* ì„±ì ì„œ (ì „ì²´ í­) */
.cert-section{
  background:rgba(7,10,20,0.5); border:1px solid var(--line); border-radius:10px;
  padding:12px; grid-column:1/-1;
}
.cert-label{
  font-size:12px; color:var(--muted); font-weight:500; margin-bottom:8px;
}
.cert-btn{
  display:inline-flex; align-items:center; gap:8px;
  padding:10px 16px; background:var(--accent); color:#000;
  border-radius:8px; text-decoration:none; font-weight:600;
  cursor:pointer; border:none; font-size:14px; transition:all 150ms;
}
.cert-btn:hover{background:#60d5ff; transform:translateY(-2px)}
.cert-text{color:var(--muted); font-size:13px}

/* ë¹ˆ ê²°ê³¼ */
.empty{
  padding:40px 20px; text-align:center;
  border:2px dashed var(--line); border-radius:12px;
  color:var(--danger); font-size:15px;
}

/* í‘¸í„° */
footer{margin-top:48px; padding-top:24px; border-top:1px solid var(--line);
  text-align:center; font-size:12px; color:var(--muted)}

/* í•œê¸€/ì˜ë¬¸ í°íŠ¸ í¬ê¸° */
.eng{font-size:13px; opacity:0.75; margin-left:4px}

/* ëª¨ë°”ì¼ ë°˜ì‘í˜• (768px ì´í•˜) */
@media(max-width:768px){
  .wrapper{padding:20px 12px 60px}
  header h1{font-size:22px}
  .search-box{
    flex-direction:column; padding:16px;
  }
  .search-box input, .search-box button{width:100%}
  .result-grid{
    grid-template-columns:1fr; gap:16px;
  }
  .info-grid{
    grid-template-columns:1fr; gap:10px;
  }
}

/* íƒœë¸”ë¦¿ (768px ~ 1024px) */
@media(max-width:1024px){
  .result-grid{gap:16px; padding:0 12px}
  .info-grid{gap:10px}
}
</style>
</head>
<body>
<div class="wrapper">
<header>
  <h1>ğŸ” ì‹œë¦¬ì–¼ ë„˜ë²„ ê²€ìƒ‰ê¸° <span class="eng">(Serial Number Search)</span></h1>
  <p>êµ¬í˜•/ì‹ í˜• ì‹œíŠ¸ë¥¼ í†µí•© ê²€ìƒ‰í•©ë‹ˆë‹¤. <span class="eng">(Unified search)</span></p>
</header>

<section class="search-box">
  <input id="serialInput" type="text" placeholder="ì˜ˆ: DM202510117">
  <button class="btn-search" onclick="search()">ê²€ìƒ‰ (Search)</button>
  <button class="btn-reset" onclick="resetForm()">ì´ˆê¸°í™” (Reset)</button>
</section>

<section id="result" class="result-area"></section>

<footer>Â© SEDNAENG</footer>
</div>

<script>
const SPREADSHEET_ID = "1S6NfRpDYdBJgnfdweINyqVs_NQhZi-T2uOABSx_3JnU";
const SHEETS = ["êµ¬í˜•","ì‹ í˜•"];
const GRADE_SHEET = "ì„±ì ì„œ";
const COL = {company:3, wp:5, delivery:7, model:9, project:11, serial:17};
const K_INDEX = 10;

function buildKey(raw){
  if(!raw) return "";
  let v = raw.toUpperCase().replace(/\s+/g,"");
  let out = "";
  for(let i=0; i<v.length; i++){
    const ch = v[i];
    if((i===3 || i===4) && /[A-Z]/.test(ch)) continue;
    out += ch;
  }
  return out;
}

// ìˆ˜ëŸ‰: ì¤„ë°”ê¿ˆ ê¸°ì¤€ìœ¼ë¡œ ë‚˜ëˆ„ê³  ê° ì¤„ ë’¤ì— ea
function formatQty(raw){
  if(raw === undefined || raw === null) return "-";
  const text = raw.toString().trim();
  if(!text) return "-";
  const lines = text.split(/(\r\n|\r|\n)/); // ì¤„ë°”ê¿ˆ ë³´ì¡´
  const out = lines.map(part=>{
    if(/^\r\n$|^\r$|^\n$/.test(part)) return "<br>"; // ì¤„ë°”ê¿ˆì€ <br>
    const t = part.trim();
    if(!t) return "";
    return t + "ea";
  }).join("");
  return out || "-";
}

async function loadGradeMap(){
  const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?sheet=${encodeURIComponent(GRADE_SHEET)}&tqx=out:json`;
  const txt = await fetch(url).then(r=>r.text());
  const json = JSON.parse(txt.substring(txt.indexOf("{"), txt.lastIndexOf("}")+1));
  const rows = json.table.rows || [];
  const map = new Map();
  rows.forEach(r=>{
    const row = r.c.map(c=>c?c.v:"");
    const serials = (row[2]||"").toString().split(/,|\n/).map(s=>buildKey(s)).filter(Boolean);
    const rawUrl = row[11];
    if(!rawUrl) return;
    const cleanUrl = rawUrl.toString().trim();
    serials.forEach(s=>{
      if(s && cleanUrl) map.set(s, cleanUrl);
    });
  });
  return map;
}

async function search(){
  const input = document.getElementById("serialInput").value;
  const box = document.getElementById("result");
  box.innerHTML = '<div class="empty">ê²€ìƒ‰ ì¤‘ì…ë‹ˆë‹¤... <span class="spinner"></span></div>';
  const key = buildKey(input);
  if(!key){
    box.innerHTML = `<div class="empty">ì‹œë¦¬ì–¼ ì…ë ¥ í•„ìš” <span class="eng">(Please enter serial number)</span></div>`;
    return;
  }
  const gradeMap = await loadGradeMap();
  let hits = [];
  for(const sheet of SHEETS){
    const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?sheet=${encodeURIComponent(sheet)}&tqx=out:json`;
    const txt = await fetch(url).then(r=>r.text());
    const json = JSON.parse(txt.substring(txt.indexOf("{"), txt.lastIndexOf("}")+1));
    const rows = json.table.rows || [];
    rows.forEach(r=>{
      const row = r.c.map(c=>c?c.v:"");
      const serials = (row[COL.serial]||"").toString().split(",").map(s=>buildKey(s));
      serials.forEach(s=>{
        if(s === key){
          hits.push({sheet,row,matchedSerial:s});
        }
      });
    });
  }
  if(!hits.length){
    box.innerHTML = `<div class="empty">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ <span class="eng">(No results found)</span></div>`;
    return;
  }
  
  let html = '<div class="result-grid">';
  hits.forEach(hit=>{
    const gUrl = (gradeMap.get(hit.matchedSerial)||"").toString().trim();
    const isFolder = gUrl.includes("/drive/folders/");
    const sheetTag = hit.sheet === "êµ¬í˜•" ? "êµ¬í˜• (Old)" : "ì‹ í˜• (New)";
    
    html += `
    <div class="card">
      <div class="card-header">
        <div class="card-title">ğŸ” ê²€ìƒ‰ ê²°ê³¼ <span class="eng">(Result)</span></div>
        <span class="tag">${sheetTag}</span>
      </div>
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label">ì—…ì²´ëª… (Company)</div>
          <div class="info-value">${hit.row[COL.company]||"-"}</div>
        </div>
        <div class="info-item">
          <div class="info-label">ëª¨ë¸ëª… (Model)</div>
          <div class="info-value">${hit.row[COL.model]||"-"}</div>
        </div>
        <div class="info-item">
          <div class="info-label">ë‚©í’ˆì¼ (Delivery)</div>
          <div class="info-value">${hit.row[COL.delivery]||"-"}</div>
        </div>
        <div class="info-item">
          <div class="info-label">W/P ë‚©í’ˆì¼ (WP Date)</div>
          <div class="info-value">${hit.row[COL.wp]||"-"}</div>
        </div>
        <div class="info-item">
          <div class="info-label">ìˆ˜ëŸ‰ (Qty)</div>
          <div class="info-value">${formatQty(hit.row[K_INDEX])}</div>
        </div>
        <div class="info-item">
          <div class="info-label">í”„ë¡œì íŠ¸ (Project)</div>
          <div class="info-value">${hit.row[COL.project]||"-"}</div>
        </div>
      </div>
      <div class="cert-section">
        <div class="cert-label">ì„±ì ì„œ (Certificate)</div>
        ${gUrl 
          ? `<a href="${encodeURI(gUrl)}" target="_blank" rel="noopener noreferrer" class="cert-btn">
               ğŸ“¥ ${isFolder ? 'í´ë” ì—´ê¸° (Open Folder)' : 'ë‹¤ìš´ë¡œë“œ (Download)'}
             </a>`
          : `<span class="cert-text">ë¯¸ë“±ë¡ (Not Registered)</span>`
        }
      </div>
    </div>`;
  });
  html += '</div>';
  box.innerHTML = html;
}

function resetForm(){
  document.getElementById("serialInput").value="";
  document.getElementById("result").innerHTML="";
}

window.addEventListener("load", ()=>{  
  const params = new URLSearchParams(window.location.search);
  const serial = params.get("sn");
  if(serial){
    document.getElementById("serialInput").value = serial;
    search();
  }
  
  document.getElementById("serialInput").addEventListener("keydown", function(e) {
    if (e.key === "Enter") {
      e.preventDefault();
      search();
    }
  });
});
</script>
</body>
</html>
